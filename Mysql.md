# MySQL 体系

![微信图片_20220307232508](image\微信图片_20220307232508.png)

## Mysql引擎

1. **连接层**  最上层是一些客户端和链接服务,主要完成一些类似于连接处理、授权认证、及相关的安全方案。服务器也会为安全接入的每个客户端验证它所具有的操作权限。
2. **服务层 ** 第二层架构主要完成大多数的核心服务功能,如SQL接口,并完成缓存的查询,SQL的分析和优化,部分内置函数的执行。所有跨存储引擎的功能也在这一层实现,如过程、函数等。
3. **引擎层 ** 存储引擎真正的负责了MySQL中数据的存储和提取,服务器通过API和存储引擎进行通信。不同的存储引擎具有不同的功能,这样我们可以根据自己的需要,来选取合适的存储引擎。
4. **存储层**  主要是将数据存储在文件系统之上,并完成与存储引擎的交互。 

###  存储引擎  （表类型）

存储引擎就是存储数据、建立索引、更新/查询数据等技术的实现方式。存储引擎是基于表的,而不是基于库的,所以存储引擎也可被称为表类型。 

#### InnoDB

​	InnoDB是一种兼顾高可靠性和高性能的通用存储引擎,在MySQL 5.5 之后, InnoDB是默认的MySQL存储引擎。

特点：
- DML操作遵循ACID模型,支持**事务**;
- **行级锁**,提高并发访问性能;
- 支持**外键**FOREIGN KEY约束,保证数据的完整性和正确性I; 
XXX.ibd: xxx代表的是表名,InnoDB引擎的每张表都会对应这样一个表空间文件,存储该表的表结构(frm、sdi)、数据和索引。参数: innodb_file_per_table 

文件特点：X

XXX.ibd:   XXX代表的是表名,InnoDB引擎的**每张表**都会对应这样一个表空间文件,存储该表的表结构(frm（8.0之后默认sdi）、sdi)、数据和索引。
参数: innodb_file_per_table (默认打开)

InnoDB逻辑存储结构

![微信图片_20220307234550](image\微信图片_20220307234550.png)
TableSpece：表空间
Segment：段
Extent：区
Page：页
Row：行

#### MyISAM（Mysql早期存储引擎）

特点：

1. 不支持事务,

2. 不支持外键支持表锁,

3. 不支持行锁，

4. 访问速度快 .

文件类型：
1. XXX.sdi:存储表结构信息
2. XXX.MYD:存储数据
3. XXX.MYI:存储索引 

#### Memory （文件存放在内存当中）

Memory引擎的表数据是存储在内存中的，由于受到硬件问题、或断电问题的影响,只能将这些表作为临时表或缓存使用。

特点：

​	内存存放
​	支持hash索引

### 各大引擎特点及区别

![微信图片_20220307235843](image\微信图片_20220307235843.png)

**存储引擎适用场景：**

**InnoDB** :	是Mysql的默认存储引擎,支持事务、外键。如果应用对事务的完整性有比较高的要求,在并发条件下要求数据的一致数据操作除了插入和查询之外,还包含很多的更新、删除操作,那么InnoDB存储引擎是比较合适的选择。

**MyISAM**:	如果应用是以读操作和插入操作为主,只有很少的更新和删除操作,并且对事务的完整性、并发性要求不是很高,那么选择这个存储引擎是非常合适的。

**MEMORY**:	将所有数据保存在内存中,访问速度快,通常用于临时表及缓存。MEMORY的缺陷就是对表的大小有限制,太大的表无法缓存在内存中,而且无法保障数据的安全性。 

## Mysql索引

### 索引简述

​		索引(index)是帮助MySQL高效获取数据的数据结构(有序)。在数据之外,数据库系统还维护着满足特定查找算法的数据结构,这些数据结构以某种方式引用(指向)数据,这样就可以在这些数据结构上实现高级查找算法,这种数据结构就是索引。

索引的优势：

1. 提高数据的检索速度，降低了数据库的IO成本。

2. 通过索引列对数据进行排序，降低了数据排序的成本，降低了CPU的消耗。


索引的劣势：

1. 索引需要占据空间。（磁盘便宜，算不上大缺点）
2. 索引大大提高了数据的查询效率，但是也相应的降低了更新表的速度，如对表进行增删改时，都会引起所赢得改变，效率低。

### 索引操作基础

**基础查询**

``` sql
#查询user表索引
show index from user[\G(以竖列方式查看)];
```

**创建索引**

(在INNODB下默认创建B+Tree索引，显示为BTREE)

``` sql
# 1. name字段为姓名字段,该字段的值可能会重复,为该字段创建索引
create index idx_user_name on user(name);
#2. phone手机号字段的值,是非空,且唯一的,为该字段创建唯一索引
create unique index idx_user_phone on user(phone);
#3. 为profession、 age, status创建联合索引
create index idx_user_pro_age_sta on user(profession,age,status);
#4. 为email建立合适的索引来提升查询效率
create index idx_user_email on user(email);
```

**删除索引**

``` sql
#删除user表内idx_user_email索引
drop index idx_user_email on user;
```



### 索引结构

​	MySQL的索引是在存储引警层实现的,不同的存储引擎有不同的结构,主要包含以下几种:

|      索引结构       | 描述                                                         |
| :-----------------: | :----------------------------------------------------------- |
|   **B+Tree**索引    | 最常见的索引类型，大部分引擎都支持B+Tree。（Inn哦DB，Memory，MyISAM） |
|      Hash索引       | 底层数据结构是用Hash表实现的，只有精确匹配索引列才有效，**不支持范围查询**。 |
|  R-Tree(空间索引)   | 空间索引是**MyISAM**引擎的一个特殊索引类型，主要MyISAM用于地理空间数据类型，通常使用较少。 |
| Full-text(全文索引) | 是一种建立倒排索引，快速匹配文档的方式，类似于Lucene,Solr,ES。 |

| 索引           | Innodb    | Myisam | memory |
| -------------- | --------- | ------ | ------ |
| **B+Tree**索引 | 支持      | 支持   | 支持   |
| Hash索引       | 不支持    | 不支持 | 不支持 |
| R-Tree         | 不支持    | 支持   | 不支持 |
| Full-text      | 5.6后支持 | 支持   | 不支持 |

索引详细结构

#### 二叉树和红黑树

![image-20220308004707180](image\微信图片_20220308004414.png)

二叉树缺点:顺序插入时,会形成一个链表,查询性能大大降低。大数据量情况下,层级较深,检索速度慢。

红黑树:大数据量下，层级较深，检索速度慢。

#### B-Tree(多路平衡查找树)

以一颗最大度数(max-degree)为5(5阶)的B-Tree为例(每个节点最多存储4个key, 5个指针):

 ![image-20220308005236140](image\image-20220308005236140.png)

								- |->树的度数指一个节点的子节点数。

#### B+Tree

以一颗最大度数(max-degree)为4(4阶)的B+Tree为例:

![image-20220308010253822](image\image-20220308010118020.png)

​	

#### Mysql中的B+Tree

​		MySQL索引数据结构对经典的B+Tree进行了优化。在原B+Tree的基础上,增加一个指向相邻叶子节点的链表指针,就形成了带有顺序指针的B+Tree,提高区间访问的性能。

![image-20220308010929009](image\image-20220308010651212.png)

#### Hash

哈希索引就是采用一定的hash算法,将键值换算成新的hash值,映射到对应的槽位上,然后存储在hash表中。

特点：

1. Hash索引只能用于对等比较(=, in),不支持范围查询(between, >,<, 。
2.  无法利用索引完成排序操作。
3.  查询效率高,通常只需要一次检索就可以了,效率通常要高于B+tree索引。

​		**在Mysql中,支持Hash索引的是Memory引擎，而InnoDB中具有自适应Hash功能,Hash索引是存储引擎根据B+Tree索引在指定条件下自动构建的。** 

## 为什么InnoDB存储引擎选择使用B+tree索引结构?

1. 相对于二叉树,层级更少,搜索效率高;
2. 对于B-tree,无论是叶子节点还是非叶子节点,都会保存数据,这样导致页中存储的键值减少,指针跟着减少,要同样保存	大量数据,只能增加树的高度,导致性能降低; 
3. 相对Hash索引, B+tree支持范围匹配及排序操作; 

在InnoDB存储引警中,根据索引的存储形式,又可以分为以下两种:

|           分类            |                           含义                            |        特点         |
| :-----------------------: | :-------------------------------------------------------: | :-----------------: |
| 聚集索引(Clustered Index) | 将数据存储与索引放到了一块,索引结构的叶子节点保存了行数据 | 必须有,而且只有一个 |
| 二级索引(Secondary Index) | 将数据与索引分开存储,索引结构的叶子节点关联的是对应的主键 |    可以存在多个     |

聚集索引选取规则:

- 如果存在主键,主键索引就是聚集索引。
- 如果不存在主键,将使用第一个唯一(UNIQUE)索引作为聚集索引。
- 如果表没有主键,或没有合适的唯一索引,则InnoDB会自动生成一个rowid作为隐藏的聚集索引。

![image-20220308012646721](image\image-20220308012646721.png)

